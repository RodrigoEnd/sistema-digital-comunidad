name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  
  lint:
    name: Lint y Calidad de Codigo
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'
    
    - name: Instalar dependencias de lint
      run: |
        python -m pip install --upgrade pip
        pip install pylint black flake8 isort
    
    - name: Ejecutar pylint
      run: pylint src/ --disable=all --enable=E,F --fail-under=9.0 || true
    
    - name: Verificar formato con black
      run: black --check src/ || true
    
    - name: Ejecutar flake8
      run: flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics || true
    
    - name: Verificar orden de imports
      run: isort --check-only src/ || true

  
  tests:
    name: Tests Unitarios
    runs-on: ubuntu-latest
    needs: lint
    
    strategy:
      matrix:
        python-version: ['3.11', '3.12', '3.13']
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Configurar Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-xdist
    
    - name: Ejecutar tests unitarios
      run: |
        pytest tests/ -v --cov=src --cov-report=xml --cov-report=term
    
    - name: Subir coverage a Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        fail_ci_if_error: false

  
  security:
    name: Analisis de Seguridad
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'
    
    - name: Instalar herramientas de seguridad
      run: |
        python -m pip install --upgrade pip
        pip install bandit safety
    
    - name: Ejecutar bandit (seguridad)
      run: bandit -r src/ --skip B101 || true
    
    - name: Verificar vulnerabilidades de dependencias
      run: |
        pip install -r requirements.txt
        safety check || true

  
  build:
    name: Build del Proyecto
    runs-on: ubuntu-latest
    needs: [tests, security]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'
    
    - name: Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Validar que el proyecto puede importarse
      run: |
        python -c "import src.config; print('Proyecto valido')"
    
    - name: Crear estructura de directorios necesarios
      run: |
        python -c "
        import os
        dirs = [
            'src/api',
            'src/auth', 
            'src/core',
            'src/modules',
            'src/tools',
            'src/ui'
        ]
        for d in dirs:
            os.makedirs(d, exist_ok=True)
            print(f'Directorio {d} validado')
        "

  
  notify:
    name: Notificacion de Resultado
    runs-on: ubuntu-latest
    needs: [lint, tests, security, build]
    if: always()
    
    steps:
    - name: Verificar resultados
      run: |
        if [ "${{ needs.tests.result }}" == "success" ] && [ "${{ needs.lint.result }}" == "success" ]; then
          echo "CI Pipeline EXITOSO!"
          exit 0
        else
          echo "CI Pipeline FALLIDO - Revisar logs"
          exit 1
        fi
